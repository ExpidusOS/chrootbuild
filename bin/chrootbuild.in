#!/bin/bash

LIBDIR='/var/lib/manjaro-chrootbuild'
. ${LIBDIR}/util-pkg.sh
. ${LIBDIR}/util-chroot.sh

PKG_DIR=$(get_mp_conf PKGDEST)

while getopts "b:chi:l:np:rs" arg; do
    case "${arg}" in
        b) BRANCH="${OPTARG}" ;;
        c) CLEAN=true ;;
        i) INSTALL_PKG="${OPTARG}" ;;
        l) BUILD_LIST=true; INSTALL=true; buildlist="${OPTARG}" ;;
        n) INSTALL=true ;;
        p) pkg="${OPTARG}" ;;
        r) RM_PKGS=true ;;
        s) SIGN=true ;;
        h|?) usage 0 ;;
        *) usage 1 ;;
    esac
done
shift $((OPTIND -1))

# when building a list, sign all pkgs at the end.
if [ ${SIGN} = true ]; then
    if [ ${BUILD_LIST} = true ]; then
        sign=list
    else
        sign=pkg
    fi
fi

check_root
[[ ${BUILD_LIST} = true ]] && check_sanity $buildlist || check_sanity $pkg
prepare_chroot ${CHROOT_DIR}

[[ ! -z ${INSTALL_PKG} ]] && install_local_pkg ${INSTALL_PKG} ${CHROOT_DIR}
[[ ${RM_PKGS} = true ]] && rm_pkgs

if [ ${BUILD_LIST} = true ]; then
    . ${LIBDIR}/util-lists.sh
    prepare_log
    msg_wait
    [[ ! -e ${log} ]] && echo "+++ package build log +++" > $log
    #ssh_add
    build_list $buildlist
    [[ ${sign} = list ]] && sign_pkg ${PKG_DIR}
    summary
else
    build_pkg $pkg
fi

unmount_chroot ${CHROOT_DIR}
