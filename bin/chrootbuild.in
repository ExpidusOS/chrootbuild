#!/bin/bash

LIBDIR='/usr/lib/manjaro-chrootbuild'
. ${LIBDIR}/util-pkg.sh
. ${LIBDIR}/util-chroot.sh

trap 'abort "Aborted."' INT
get_pkg_dir
get_default_branch

while getopts "b:chi:l:np:rs" arg; do
    case "${arg}" in
        b) BRANCH="${OPTARG}" ;;
        c) CLEAN=true ;;
        i) install_pkgs+=("${OPTARG}") ;;
        l) lists+=("${OPTARG}"); INSTALL=true ;;
        n) INSTALL=true ;;
        p) pkgs+=("${OPTARG}") ;;
        r) RM_PKGS=true ;;
        s) SIGN=true ;;
        h|?) usage 0 ;;
        *) usage 1 ;;
    esac
done
shift $((OPTIND -1))

check_root
[[ ! -z $lists ]] && prepare_lists
[[ ! -z $pkgs ]] && prepare_pkgs
[[ $check = none ]] && abort "No list or package specified. Aborting."

prepare_chroot ${CHROOT_DIR}
job install_local_pkg "${install_pkgs[@]}"
[[ ${RM_PKGS} = true ]] && rm_pkgs
job build_pkg "${pkgs[@]}"
job build_list "${lists[@]}" 
[[ ${SIGN} = true ]] && gpg_sign ${PKG_DIR}
[[ $check = list ]] && summary

cleanup