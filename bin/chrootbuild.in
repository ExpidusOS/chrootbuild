#!/bin/bash

LIBDIR='/var/lib/manjaro-chrootbuild'
. ${LIBDIR}/util-pkg.sh
. ${LIBDIR}/util-chroot.sh

PKG_DIR=$(get_mp_conf PKGDEST)

while getopts "b:chi:l:np:rs" arg; do
    case "${arg}" in
        b) BRANCH="${OPTARG}" ;;
        c) CLEAN=true ;;
        i) install_pkgs+=("${OPTARG}") ;;
        l) BUILD_LIST=true; INSTALL=true; lists+=("${OPTARG}") ;;
        n) INSTALL=true ;;
        p) pkgs+=("${OPTARG}") ;;
        r) RM_PKGS=true ;;
        s) SIGN=true ;;
        h|?) usage 0 ;;
        *) usage 1 ;;
    esac
done
shift $((OPTIND -1))

# determine default branch
case "$(uname -m)" in
    aarch64) BRANCH="arm-unstable" ;;
    x86_64) BRANCH="unstable" ;;
esac

check_root
if [ ${BUILD_LIST} = true ]; then
    job check_sanity "${lists[@]}"
    msg "List(s) to build:"
    printf "   - %s\n" "${lists[@]//\//}"
else
    job check_sanity "${pkgs[@]}"
    msg "Package(s) to build:"
    printf "   - %s\n" "${pkgs[@]//\//}"
fi
prepare_chroot ${CHROOT_DIR}
job install_local_pkg "${install_pkgs[@]}"
[[ ${RM_PKGS} = true ]] && rm_pkgs

if [ ${BUILD_LIST} = true ]; then
    . ${LIBDIR}/util-lists.sh
    prepare_log
    msg_wait
    [[ ! -e $log ]] && echo "+++ package build log +++" > $log
    #ssh_add
    job build_list "${lists[@]}"
    summary
else
    job build_pkg "${pkgs[@]}"
fi
[[ ${SIGN} = true ]] && gpg_sign ${PKG_DIR}

unmount_chroot ${CHROOT_DIR}
