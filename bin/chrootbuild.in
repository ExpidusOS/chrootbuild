#!/bin/bash

LIBDIR='/usr/lib/manjaro-arm-chrootbuild'

. ${LIBDIR}/util-chroot.sh
. ${LIBDIR}/util-pkg.sh

CHROOT_DIR=/var/lib/chrootbuild
BUILD_DIR=${CHROOT_DIR}/build
USER_HOME=/home/${SUDO_USER}
MP_CONF_GLOB='/etc/makepkg.conf'
MP_CONF_USER="${USER_HOME}/.makepkg.conf"
PKG_DIR=$(get_mp_config PKGDEST)
BUILDUSER_UID="${SUDO_UID:-$UID}"
BUILDUSER_GID="$(id -g "${BUILDUSER_UID}")"
RM_PKGS=false
CLEAN_CHROOT=false
MIRROR='https://repo.manjaro.org/repo'
BRANCH='arm-unstable'

while getopts "b:chnrs" arg; do
    case "${arg}" in
        b) BRANCH="${OPTARG}" ;;
        c) CLEAN_CHROOT=true ;;
#       i) INSTALL_PKG="${OPTARG}" ;;
        n) INSTALL=true ;;
        r) RM_PKGS=true ;;
        s) SIGNPKG=true ;;
        h|?) usage 0 ;;
        *) usage 1 ;;
    esac
done
shift $((OPTIND -1))

get_pkg_dir
[[ ${RM_PKGS} = true ]] && rm_pkgs
prepare_chroot ${CHROOT_DIR}
# [[ INSTALL_PKG ]] && install_local_pkg
build_pkg $1

# clean up, unmount chroot fs
umount -l ${CHROOT_DIR}
